<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>anyGem OS v40.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); }
        #mask-canvas { cursor: crosshair; touch-action: none; }
    </style>
</head>
<body class="bg-[#020617] text-slate-200 font-sans h-screen flex flex-col overflow-hidden">

    <header class="p-4 border-b border-emerald-500/20 glass flex justify-between items-center z-50">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-emerald-500 rounded-lg rotate-12 flex items-center justify-center font-black text-white shadow-[0_0_20px_rgba(16,185,129,0.5)]">G</div>
            <h1 class="text-xl font-black italic tracking-tighter">anyGem <span class="text-emerald-500 underline decoration-2 underline-offset-4">v40.0</span></h1>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleDashboard()" class="p-2 hover:bg-slate-800 rounded-xl transition-all">ğŸ“Š Monitor</button>
            <select id="mode-select" class="bg-slate-900 border border-emerald-500/30 rounded-xl text-xs px-3 py-2 outline-none">
                <option value="chat">ğŸ’¬ Chat</option>
                <option value="presentation">ğŸ“Š Presentation</option>
                <option value="edit">ğŸ¨ Inpaint</option>
            </select>
        </div>
    </header>

    <main class="flex-grow overflow-hidden relative">
        <div id="chat-window" class="h-full p-4 overflow-y-auto space-y-6 scroll-smooth"></div>
        
        <div id="dashboard" class="absolute inset-y-0 left-0 w-80 glass border-r border-white/5 transform -translate-x-full transition-transform duration-500 p-6 z-40 overflow-y-auto">
            <h2 class="text-lg font-bold mb-4 text-emerald-400">System Logs</h2>
            <button onclick="handleClearCache()" class="w-full mb-4 py-2 bg-red-900/20 border border-red-500/30 text-red-400 text-xs rounded-lg hover:bg-red-500 hover:text-white transition-all">Clear Cache</button>
            <div id="log-list" class="space-y-3 text-[10px] font-mono"></div>
        </div>
    </main>

    <div id="editor-container" class="hidden fixed inset-0 z-[100] glass flex flex-col items-center justify-center p-6">
        <div class="relative bg-black rounded-2xl shadow-2xl border border-white/10 overflow-hidden">
            <canvas id="image-canvas"></canvas>
            <canvas id="mask-canvas" class="absolute top-0 left-0 opacity-50"></canvas>
        </div>
        <div class="mt-6 flex gap-4">
            <input type="range" id="brush-size" min="10" max="100" value="30" class="accent-emerald-500">
            <button onclick="confirmEdit()" class="px-8 py-3 bg-emerald-600 text-white font-bold rounded-2xl shadow-lg active:scale-95 transition-all">Start Inpainting</button>
            <button onclick="closeEditor()" class="px-8 py-3 bg-slate-700 text-white rounded-2xl">Cancel</button>
        </div>
    </div>

    <footer class="p-4 glass border-t border-white/5">
        <div class="max-w-4xl mx-auto flex gap-3 items-center">
            <input type="file" id="file-upload" class="hidden" accept="image/*,application/pdf">
            <button onclick="document.getElementById('file-upload').click()" class="p-4 bg-slate-800 rounded-2xl hover:bg-emerald-900/30 transition-all">ğŸ“</button>
            <input type="text" id="user-input" class="flex-grow bg-slate-900/50 border border-white/10 rounded-2xl px-6 py-4 outline-none focus:border-emerald-500/50 transition-all" placeholder="è¼¸å…¥ä¸»é¡Œæˆ–æŒ‡ä»¤...">
            <button id="send-btn" onclick="handleAction()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-8 py-4 rounded-2xl font-black italic transition-all shadow-lg active:scale-95">SEND</button>
        </div>
    </footer>

    <script>
        // æ ¸å¿ƒé‚è¼¯æ•´åˆ
        const API_URL = "/api/gas"; // Vercel Rewrite è·¯å¾‘
        const imgCanvas = document.getElementById('image-canvas');
        const maskCanvas = document.getElementById('mask-canvas');
        const ctxI = imgCanvas.getContext('2d');
        const ctxM = maskCanvas.getContext('2d');
        let activeFile = null, drawing = false;

        async function handleAction() {
            const mode = document.getElementById('mode-select').value;
            const text = document.getElementById('user-input').value;
            
            if (mode === 'edit' && activeFile) {
                openEditor(activeFile);
            } else {
                await sendRequest({ mode, message: text });
            }
        }

        // --- Canvas é‚è¼¯ ---
        function openEditor(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const scale = Math.min(window.innerWidth * 0.8 / img.width, 500 / img.height);
                    imgCanvas.width = maskCanvas.width = img.width * scale;
                    imgCanvas.height = maskCanvas.height = img.height * scale;
                    ctxI.drawImage(img, 0, 0, imgCanvas.width, imgCanvas.height);
                    ctxM.fillStyle = "black"; ctxM.fillRect(0, 0, maskCanvas.width, maskCanvas.height);
                    ctxM.strokeStyle = "white"; ctxM.lineCap = "round";
                    document.getElementById('editor-container').classList.remove('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        maskCanvas.onmousedown = () => drawing = true;
        maskCanvas.onmouseup = () => { drawing = false; ctxM.beginPath(); };
        maskCanvas.onmousemove = (e) => {
            if (!drawing) return;
            ctxM.lineWidth = document.getElementById('brush-size').value;
            const rect = maskCanvas.getBoundingClientRect();
            ctxM.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctxM.stroke();
        };

        async function confirmEdit() {
            const base = imgCanvas.toDataURL('image/png').split(',')[1];
            const mask = maskCanvas.toDataURL('image/png').split(',')[1];
            await sendRequest({ mode: 'edit', message: document.getElementById('user-input').value, base_image: base, mask_image: mask });
            closeEditor();
        }

        // --- API é€šè¨Š ---
        async function sendRequest(payload) {
            setLoading(true);
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const data = await res.json();
                renderMessage('ai', data.reply, data.image);
            } catch (e) { renderMessage('ai', "âŒ é€šè¨Šå¤±æ•—"); }
            finally { setLoading(false); }
        }

        function toggleDashboard() {
            const dash = document.getElementById('dashboard');
            dash.classList.toggle('-translate-x-full');
            if (!dash.classList.contains('-translate-x-full')) refreshLogs();
        }

        // è¼”åŠ©å‡½å¼... (setLoading, renderMessage, etc.)
    </script>
</body>
</html>
