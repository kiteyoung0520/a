<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>anyGem - Super Agent v64.0 (Search Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        body { background-color: #131314; color: #e3e3e3; font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
        
        /* Markdown Ê®£ÂºèÂÑ™Âåñ */
        .prose pre { background-color: #1e1e20; border-radius: 12px; padding: 1.25rem; overflow-x: auto; border: 1px solid #333; margin: 1rem 0; position: relative; }
        .prose code { color: #f87171; background-color: rgba(255,255,255,0.1); padding: 0.2rem 0.4rem; border-radius: 6px; font-size: 0.9em; font-family: 'Fira Code', monospace; }
        .prose a { color: #8ab4f8; text-decoration: underline; text-underline-offset: 4px; transition: color 0.2s; }
        .prose a:hover { color: #aecbfa; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .prose h1, .prose h2, .prose h3 { color: #fff; margin-top: 1.5rem; margin-bottom: 0.75rem; font-weight: 600; }
        .prose p { margin-bottom: 1rem; line-height: 1.7; }

        /* ÊâìÂ≠óÂãïÁï´ */
        .typing-indicator span { animation: blink 1.4s infinite both; height: 5px; width: 5px; background-color: #888; border-radius: 50%; display: inline-block; margin: 0 2px; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

        .active-session { background-color: #33353a; color: white; border-left: 4px solid #8ab4f8; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div id="preview-modal" class="fixed inset-0 z-50 hidden bg-black/90 backdrop-blur-md flex-col">
        <div class="h-14 bg-[#1e1f22] border-b border-[#333] flex items-center justify-between px-6">
            <div class="flex items-center gap-3">
                <span class="material-symbols-rounded text-blue-400">deployed_code</span>
                <span class="font-semibold text-sm tracking-wide">anyGem Artifact Preview</span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="refreshPreview()" class="p-2 text-gray-400 hover:text-white transition-colors"><span class="material-symbols-rounded">refresh</span></button>
                <button onclick="closePreview()" class="p-2 text-gray-400 hover:text-red-400 bg-[#333] hover:bg-red-500/10 rounded-full transition-all"><span class="material-symbols-rounded">close</span></button>
            </div>
        </div>
        <div class="flex-1 bg-white">
            <iframe id="preview-iframe" sandbox="allow-scripts allow-forms allow-modals" class="w-full h-full border-none"></iframe>
        </div>
    </div>

    <aside id="sidebar" class="w-72 bg-[#1e1f22] border-r border-[#333] flex flex-col transition-all duration-300 z-20 absolute md:relative h-full -translate-x-full md:translate-x-0">
        <div class="p-6">
            <div class="flex items-center gap-3 mb-8">
                <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center">
                    <span class="material-symbols-rounded text-white text-xl">auto_awesome</span>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-white">anyGem Agent</h1>
            </div>
            <button onclick="startNewSession()" class="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-3 rounded-xl transition-all shadow-lg shadow-blue-900/20">
                <span class="material-symbols-rounded">add</span> Êñ∞Â∞çË©±
            </button>
        </div>
        <div id="session-list" class="flex-1 overflow-y-auto px-3 space-y-1">
            </div>
        <div class="p-4 border-t border-[#333] text-xs text-gray-500 text-center font-mono">v64.0 Search Edition</div>
    </aside>

    <main class="flex-1 flex flex-col relative bg-[#131314]">
        <header class="h-14 flex items-center justify-between px-4 md:hidden border-b border-[#333] bg-[#1e1f22]">
            <button onclick="toggleSidebar()" class="p-2 text-gray-400"><span class="material-symbols-rounded">menu</span></button>
            <span class="font-semibold text-sm" id="mobile-title">Êñ∞Â∞çË©±</span>
            <div class="w-10"></div>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto px-4 py-8 md:px-12 space-y-8 pb-40">
            <div class="max-w-3xl mx-auto flex gap-6">
                <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center shadow-lg"><span class="material-symbols-rounded text-white">smart_toy</span></div>
                <div>
                    <h2 class="text-2xl font-bold text-white mb-2">ÊàëÊòØÊÇ®ÁöÑ anyGem ‰ª£ÁêÜ‰∫∫</h2>
                    <p class="text-gray-400">ÊàëÂ∑≤Ê∫ñÂÇôÂ•ΩÂçîÂä©ÊÇ®ËôïÁêÜÊó•ÊõÜ„ÄÅÊñá‰ª∂„ÄÅÁ≠ÜË®òÊàñÈñãÁôºÂ∑•ÂÖ∑„ÄÇÊÇ®ÂèØ‰ª•ÈñãÂïü‰∏ãÊñπ„ÄåÈÄ£Á∂≤Ê®°Âºè„ÄçËÆìÊàëÊêúÂ∞ãÊúÄÊñ∞Ë≥áË®ä„ÄÇ</p>
                </div>
            </div>
        </div>

        <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-[#131314] via-[#131314] to-transparent pt-10 pb-8 px-4 md:px-12">
            <div class="max-w-3xl mx-auto">
                <div id="upload-preview-container" class="hidden flex gap-3 mb-4">
                    <div class="relative group">
                        <img id="image-preview" class="hidden h-20 w-20 object-cover rounded-xl border-2 border-blue-500/50 shadow-xl">
                        <div id="doc-preview" class="hidden flex items-center gap-3 bg-[#2a2b2f] p-4 rounded-xl border border-[#444] shadow-xl">
                            <span class="material-symbols-rounded text-blue-400">description</span>
                            <span id="doc-filename" class="text-sm font-medium truncate max-w-[150px]"></span>
                        </div>
                        <button onclick="clearUpload()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-all shadow-lg"><span class="material-symbols-rounded text-xs">close</span></button>
                    </div>
                </div>

                <div class="bg-[#1e1f22] rounded-2xl border border-[#333] shadow-2xl focus-within:border-blue-500 transition-all p-2">
                    <div class="flex items-center gap-2 px-3 mb-2 pt-1 border-b border-[#333] pb-2">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="web-search-toggle" class="sr-only peer">
                            <div class="w-8 h-4 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-blue-600"></div>
                            <span class="ml-2 text-xs font-medium text-gray-400 peer-checked:text-blue-400 flex items-center gap-1">
                                <span class="material-symbols-rounded text-sm">language</span> ÈÄ£Á∂≤ÊêúÂ∞ãÊ®°Âºè
                            </span>
                        </label>
                    </div>
                    
                    <div class="flex items-end gap-2 mt-1">
                        <button onclick="document.getElementById('file-upload').click()" class="p-3 text-gray-400 hover:text-white hover:bg-[#333] rounded-xl transition-all"><span class="material-symbols-rounded">attach_file</span></button>
                        <input type="file" id="file-upload" class="hidden" onchange="handleFileUpload(event)" accept="image/*,application/pdf,text/*">
                        
                        <textarea id="user-input" rows="1" placeholder="Ëº∏ÂÖ•Êåá‰ª§ÊàñÂïèÈ°å..." class="w-full bg-transparent border-none outline-none text-gray-100 py-3 px-2 resize-none max-h-60"></textarea>
                        
                        <button id="send-btn" onclick="sendMessage()" class="p-3 bg-white text-black rounded-xl hover:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed transition-all shadow-lg">
                            <span class="material-symbols-rounded">send</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ‚ö†Ô∏è Ë´ãÂú®Ê≠§ËôïÊõøÊèõÊàêÊÇ®ÁöÑ GAS ÈÉ®ÁΩ≤Á∂≤ÂùÄ
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwsng4RBCTX67my46U4fv7BhDYT0CIZt95dL7DNCFJTGUJLZFd_854vRGeUsQ1_BjG9/exec";

        let currentSessionId = generateUUID();
        let currentImageData = null, currentMimeType = null, currentDocumentText = null, currentDocumentName = null;
        let isWaiting = false, currentRenderCode = "";

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight > 240 ? 240 : this.scrollHeight) + 'px';
        });

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                if (window.innerWidth < 768) return;
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text && !currentImageData && !currentDocumentText) return;
            if (isWaiting) return;

            // üöÄ Êñ∞Â¢ûÔºöÊäìÂèñÈñãÈóúÁãÄÊÖã
            const isWebSearchEnabled = document.getElementById('web-search-toggle').checked;

            let displayUserText = currentDocumentName ? `üìé [Êñá‰ª∂: ${currentDocumentName}]\n${text}` : text;
            appendMessage('user', displayUserText, currentImageData);
            
            let payloadText = text || "Ë´ãÂàÜÊûêÊ≠§ÂÖßÂÆπ";
            if (currentDocumentText) payloadText = `„ÄêÊ™îÊ°àÔºö${currentDocumentName}„Äë\n${currentDocumentText}\n\nÊåá‰ª§Ôºö${payloadText}`;

            userInput.value = ''; userInput.style.height = 'auto';
            const imgBase64 = currentImageData ? currentImageData.split(',')[1] : null;
            const mime = currentMimeType;
            clearUpload();

            isWaiting = true; sendBtn.disabled = true;
            const loadingId = appendLoading();

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        message: payloadText, 
                        session_id: currentSessionId, 
                        file_data: imgBase64, 
                        mime_type: mime,
                        web_search: isWebSearchEnabled // üöÄ ÂÇ≥ÈÅûÈÄ£Á∂≤ÁãÄÊÖã
                    })
                });
                const data = await response.json();
                removeLoading(loadingId);

                if (data.status === "error") throw new Error(data.error);
                appendMessage('ai', data.reply, data.image ? `data:${data.mime};base64,${data.image}` : null, data.model);
                loadSessions(); 
            } catch (err) {
                removeLoading(loadingId);
                appendMessage('ai', `‚ùå Âü∑Ë°åÂ§±ÊïóÔºö\n\`\`\`text\n${err.message}\n\`\`\``);
            } finally {
                isWaiting = false; sendBtn.disabled = false;
            }
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImageData = e.target.result; currentMimeType = file.type;
                    document.getElementById('image-preview').src = currentImageData;
                    document.getElementById('image-preview').classList.remove('hidden');
                    document.getElementById('doc-preview').classList.add('hidden');
                    document.getElementById('upload-preview-container').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const pdf = await pdfjsLib.getDocument(new Uint8Array(e.target.result)).promise;
                    let text = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(s => s.str).join(' ') + "\n";
                    }
                    setDocPayload(file.name, text);
                };
                reader.readAsArrayBuffer(file);
            } else {
                const reader = new FileReader();
                reader.onload = (e) => setDocPayload(file.name, e.target.result);
                reader.readAsText(file);
            }
        }

        function setDocPayload(name, text) {
            currentDocumentName = name; currentDocumentText = text;
            document.getElementById('doc-filename').innerText = name;
            document.getElementById('doc-preview').classList.remove('hidden');
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('upload-preview-container').classList.remove('hidden');
        }

        function clearUpload() {
            currentImageData = null; currentDocumentText = null; currentDocumentName = null;
            document.getElementById('upload-preview-container').classList.add('hidden');
        }

        function appendMessage(role, text, imageSrc = null, model = null) {
            const isAI = role === 'ai';
            const wrap = document.createElement('div');
            wrap.className = `flex gap-4 max-w-4xl mx-auto w-full ${!isAI ? 'flex-row-reverse' : ''}`;
            
            const avatar = `<div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg ${isAI ? 'bg-blue-600' : 'bg-gray-700'}">
                <span class="material-symbols-rounded text-white text-xl">${isAI ? 'smart_toy' : 'person'}</span>
            </div>`;

            let body = `<div class="flex-1 ${!isAI ? 'text-right' : ''} space-y-2 max-w-[85%]">`;
            if (imageSrc) body += `<img src="${imageSrc}" class="rounded-xl border border-[#333] shadow-xl mb-2 max-w-full">`;
            if (text) body += `<div class="prose prose-invert text-gray-200 bg-[#1e1f22] p-5 rounded-2xl rounded-tl-none shadow-sm">${isAI ? marked.parse(text) : text.replace(/\n/g, '<br>')}</div>`;
            if (model === 'Agent-Executor') body += `<div class="text-[10px] text-blue-400 font-mono mt-2 flex items-center gap-1"><span class="material-symbols-rounded text-xs">settings_suggest</span>AGENT ACTION COMPLETED</div>`;
            body += `</div>`;

            wrap.innerHTML = avatar + body;
            chatContainer.appendChild(wrap);

            if (isAI) {
                wrap.querySelectorAll('pre code.language-html').forEach(code => {
                    const btn = document.createElement('button');
                    btn.className = "absolute top-3 right-3 bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1.5 rounded-lg flex items-center gap-1 transition-all shadow-lg";
                    btn.innerHTML = '<span class="material-symbols-rounded text-sm">play_circle</span> È†êË¶ΩÁ∂≤È†Å';
                    btn.onclick = () => openPreview(code.innerText);
                    code.parentElement.appendChild(btn);
                });
            }
            scrollToBottom();
        }

        function appendLoading() {
            const id = 'loader-' + Date.now();
            const div = document.createElement('div');
            div.id = id; div.className = "flex gap-4 max-w-4xl mx-auto w-full";
            div.innerHTML = `<div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center animate-pulse"><span class="material-symbols-rounded text-white">hourglass_empty</span></div>
                <div class="pt-3 flex gap-2 items-center text-gray-500 text-sm font-medium italic typing-indicator">‰ª£ÁêÜ‰∫∫Ê≠£ÂøôÁ¢å‰∏≠<span></span><span></span><span></span></div>`;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) { const el = document.getElementById(id); if (el) el.remove(); }
        function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }

        function generateUUID() { return 'xxxx-4xxx-yxxx'.replace(/[xy]/g, c => (c === 'x' ? (Math.random() * 16 | 0) : (Math.random() * 16 | 0 & 0x3 | 0x8)).toString(16)); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
        
        function startNewSession() {
            currentSessionId = generateUUID();
            chatContainer.innerHTML = '';
            appendMessage('ai', "ÊÇ®Â•ΩÔºÅÂ∑≤ÁÇ∫ÊÇ®ÈñãÂïüÊñ∞ÁöÑÂ∞çË©±„ÄÇË´ãÂïèÊúâ‰ªÄÈ∫ºÊàëÂèØ‰ª•Âπ´ÊÇ®ÁöÑÔºü");
            if (window.innerWidth < 768) toggleSidebar();
            loadSessions();
        }

        async function switchSession(id, title) {
            if (id === currentSessionId && chatContainer.children.length > 1) return;
            currentSessionId = id;
            document.getElementById('mobile-title').innerText = title;
            chatContainer.innerHTML = '';
            const loadingId = appendLoading();
            if (window.innerWidth < 768) toggleSidebar();

            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ mode: 'system', action: 'load_session', session_id: id }) });
                const data = await res.json();
                removeLoading(loadingId);
                data.logs.forEach(l => appendMessage(l.role === 'ai' ? 'ai' : 'user', l.text));
                loadSessions();
            } catch (e) { console.error(e); }
        }

        async function loadSessions() {
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ mode: 'system', action: 'get_session_list' }) });
                const data = await res.json();
                const list = document.getElementById('session-list');
                list.innerHTML = '';

                data.sessions.forEach(s => {
                    const isActive = s.id === currentSessionId;
                    const item = document.createElement('div');
                    item.className = `group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all ${isActive ? 'active-session' : 'text-gray-400 hover:bg-[#2a2b2f] hover:text-white'}`;
                    
                    const titleWrap = document.createElement('div');
                    titleWrap.className = "flex items-center gap-3 flex-1 truncate";
                    titleWrap.innerHTML = `<span class="material-symbols-rounded text-lg">${isActive ? 'chat_bubble' : 'chat'}</span> <span class="truncate text-sm">${s.title}</span>`;
                    
                    item.addEventListener('click', () => switchSession(s.id, s.title));

                    const btns = document.createElement('div');
                    btns.className = `flex items-center gap-1 ${isActive ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`;
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = "p-1 hover:text-blue-400";
                    editBtn.innerHTML = '<span class="material-symbols-rounded text-sm">edit</span>';
                    editBtn.onclick = (e) => { e.stopPropagation(); renameSession(s.id, s.title); };

                    const delBtn = document.createElement('button');
                    delBtn.className = "p-1 hover:text-red-400";
                    delBtn.innerHTML = '<span class="material-symbols-rounded text-sm">delete</span>';
                    delBtn.onclick = (e) => { e.stopPropagation(); deleteSession(s.id); };

                    btns.appendChild(editBtn); btns.appendChild(delBtn);
                    item.appendChild(titleWrap); item.appendChild(btns);
                    list.appendChild(item);
                });
            } catch (e) { console.error(e); }
        }

        async function renameSession(id, old) {
            const n = prompt("ÈáçÂëΩÂêçÂ∞çË©±Ôºö", old);
            if (n && n.trim()) {
                await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ mode: 'system', action: 'rename_session', session_id: id, new_title: n }) });
                loadSessions();
            }
        }

        async function deleteSession(id) {
            if (confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÂ∞çË©±ÂóéÔºü")) {
                await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ mode: 'system', action: 'delete_session', session_id: id }) });
                if (id === currentSessionId) startNewSession(); else loadSessions();
            }
        }

        function openPreview(code) {
            currentRenderCode = code;
            document.getElementById('preview-modal').classList.remove('hidden');
            document.getElementById('preview-modal').classList.add('flex');
            document.getElementById('preview-iframe').srcdoc = code;
        }
        function closePreview() { document.getElementById('preview-modal').classList.add('hidden'); }
        function refreshPreview() { document.getElementById('preview-iframe').srcdoc = currentRenderCode; }

        window.onload = loadSessions;
    </script>
</body>
</html>
