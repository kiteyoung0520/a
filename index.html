<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>anyGem AI v56.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #020617; color: #e2e8f0; height: 100vh; display: flex; }
        #sidebar { width: 260px; background: #0f172a; border-right: 1px solid #1e293b; display: flex; flex-direction: column; }
        .history-item { padding: 10px; cursor: pointer; border-radius: 8px; margin: 5px 10px; font-size: 13px; color: #94a3b8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-item:hover { background: #1e293b; color: white; }
        .history-item.active { background: #10b98122; color: #10b981; }
        #chat-window { flex: 1; overflow-y: auto; padding: 40px; }
        .msg-bubble { max-width: 80%; padding: 15px; border-radius: 15px; margin-bottom: 20px; line-height: 1.6; }
        .user .msg-bubble { background: #059669; margin-left: auto; }
        .ai .msg-bubble { background: #1e293b; border: 1px solid #334155; }
        input, select, textarea { background: #1e293b; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>
    <aside id="sidebar">
        <button onclick="newChat()" class="m-4 p-3 border border-slate-700 rounded-lg hover:bg-slate-800"><i class="fas fa-plus mr-2"></i> New Chat</button>
        <div id="history-list" class="flex-1 overflow-y-auto"></div>
    </aside>

    <main class="flex-1 flex flex-direction-column relative">
        <header class="p-4 border-b border-slate-800 flex justify-between items-center">
            <h1 class="font-bold text-xl">anyGem <span class="text-emerald-500">v56</span></h1>
            <select id="mode"><option value="chat">Chat</option><option value="presentation">Slides</option><option value="drawing">Art</option></select>
        </header>

        <div id="chat-window"></div>

        <footer class="p-4 bg-slate-900/50 backdrop-blur flex gap-3">
            <input type="file" id="file" class="hidden" onchange="previewFile()">
            <button onclick="document.getElementById('file').click()" class="w-12 h-12 rounded-lg bg-slate-800"><i class="fas fa-paperclip"></i></button>
            <textarea id="input" class="flex-1 h-12" placeholder="Ask anything..."></textarea>
            <button onclick="send()" class="bg-emerald-600 px-6 rounded-lg font-bold">SEND</button>
        </footer>
    </main>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbwsng4RBCTX67my46U4fv7BhDYT0CIZt95dL7DNCFJTGUJLZFd_854vRGeUsQ1_BjG9/exec"; // ⚠️ 貼上你的 Web App URL
        let sid = localStorage.getItem('sid') || "S"+Date.now();
        localStorage.setItem('sid', sid);

        async function fetchHistory() {
            const r = await fetch(API, {method:'POST', body:JSON.stringify({mode:'system', action:'get_session_list'})});
            const d = await r.json();
            const list = document.getElementById('history-list');
            list.innerHTML = d.sessions.map(s => `<div class="history-item ${s.id===sid?'active':''}" onclick="loadSession('${s.id}')">${s.title}</div>`).join('');
        }

        async function loadSession(id) {
            sid = id; localStorage.setItem('sid', id);
            const r = await fetch(API, {method:'POST', body:JSON.stringify({mode:'system', action:'load_session', session_id:id})});
            const d = await r.json();
            document.getElementById('chat-window').innerHTML = '';
            d.logs.forEach(l => addMsg(l.role, l.text));
            fetchHistory();
        }

        function newChat() { sid = "S"+Date.now(); localStorage.setItem('sid', sid); document.getElementById('chat-window').innerHTML = ''; fetchHistory(); }

        async function send() {
            const msg = document.getElementById('input').value;
            if(!msg) return;
            addMsg('user', msg);
            document.getElementById('input').value = '';
            
            const payload = { mode: document.getElementById('mode').value, message: msg, session_id: sid, options: {length: 6} };
            const r = await fetch(API, {method:'POST', body:JSON.stringify(payload)});
            const d = await r.json();
            addMsg('ai', d.reply, d.image);
            fetchHistory();
        }

        function addMsg(role, text, img) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'user' : 'ai'}`;
            let content = marked.parse(text);
            if(img) content += `<img src="data:image/png;base64,${img}" class="mt-4">`;
            div.innerHTML = `<div class="msg-bubble">${content}</div>`;
            document.getElementById('chat-window').appendChild(div);
            document.getElementById('chat-window').scrollTop = 99999;
        }

        fetchHistory();
    </script>
</body>
</html>
